error_log /var/www/bounded_sites/aaesq/log/error.log;
access_log /var/www/bounded_sites/aaesq/log/access.log;

server {
    server_name spring-conference.ca www.spring-conference.ca;
    root /var/www/bounded_sites/aaesq/volume/app/main;

    # Add all security headers together
    add_header X-Frame-Options "SAMEORIGIN" always; 
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-only" always;
    add_header Content-Security-Policy "frame-ancestors 'self'" always;

    add_header X-Served-By $server_name;
    add_header X-Request-Host $host;
    add_header Cache-Control "no-cache" always;
    add_header Pragma "no-cache" always;

    # Vary header to prevent proxy caching
    add_header Vary "*";

    # If using CloudFlare or similar:
    add_header CDN-Cache-Control "no-cache";

    client_max_body_size 30M;

    proxy_cache off;
    proxy_no_cache 1;

    index index.php;

    charset utf-8;

    # Prevent directory listing
    autoindex off;

    # Optional: Deny access to hidden files (like .env)
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }



    # WordPress admin redirect
    location /wp-admin/ {
        rewrite ^/wp-admin/$ /wp-admin/index.php permanent;
        try_files $uri $uri/ /index.php?$query_string;
    }

    location / {
        try_files $uri /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME /var/www/html/$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_index  index.php;
   	    # Block direct access to PHP, TXT, LOG, JSON in wp-content
	    location ~* ^/wp-content/plugins/.*\.(php|txt|log|json)$ {
	       	 deny all;
       		 access_log off;
        	 log_not_found off;
    	    }

	    location ~* ^/wp-content/themes/.*\.(php|txt|log|json)$ {
                 deny all;
                 access_log off;
                 log_not_found off;
            }


    }

    location ~ /\.(?!well-known).* {
        deny all;
    }



    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/spring-conference.ca/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/spring-conference.ca/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}


server {
    if ($host = www.spring-conference.ca) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    if ($host = spring-conference.ca) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    server_name spring-conference.ca www.spring-conference.ca;
    listen 80;
    return 404; # managed by Certbot




}